name: CI

on:
  pull_request:
  workflow_dispatch:

jobs:
  app-quality:
    name: App quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json
      - run: npm ci
      - run: npm run lint
      - run: npm run build
      - run: npm run test:unit

  functions-quality:
    name: Functions quality
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: functions
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: functions/package-lock.json
      - run: npm ci
      - run: npm test

  perf-budget:
    name: Lighthouse performance budget
    runs-on: ubuntu-latest
    needs: app-quality
    defaults:
      run:
        working-directory: app
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: app/package-lock.json
      - run: npm ci
      - run: npm run build
      - run: mkdir -p test-artifacts
      - name: Start preview and run Lighthouse budget
        run: |
          npm run preview -- --host 127.0.0.1 --port 4173 > /tmp/vite-preview.log 2>&1 &
          PREVIEW_PID=$!

          for _ in {1..45}; do
            if curl -sfI http://127.0.0.1:4173 >/dev/null; then
              break
            fi
            sleep 1
          done

          if ! curl -sfI http://127.0.0.1:4173 >/dev/null; then
            echo "Preview server failed to start"
            cat /tmp/vite-preview.log
            kill "$PREVIEW_PID" || true
            exit 1
          fi

          npm run test:perf
          kill "$PREVIEW_PID" || true
